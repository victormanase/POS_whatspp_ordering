{% extends "base.html" %}

{% block content %}
<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-primary">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="text-uppercase text-muted mb-1">Today's Sales</h6>
                        <h4 class="mb-0">{{ formatCurrency(stats.today_sales_total or 0) }}</h4>
                        <small class="text-muted">{{ stats.today_sales_count }} transactions</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-success">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="text-uppercase text-muted mb-1">Week Revenue</h6>
                        <h4 class="mb-0">{{ formatCurrency(stats.week_sales_total or 0) }}</h4>
                        <small class="text-success"><i class="fas fa-arrow-up"></i> This week</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-money-bill-wave fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-warning">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="text-uppercase text-muted mb-1">Low Stock Items</h6>
                        <h4 class="mb-0">{{ stats.low_stock_products }}</h4>
                        <small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Need attention</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-boxes fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-info">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="text-uppercase text-muted mb-1">WhatsApp Orders</h6>
                        <h4 class="mb-0">{{ stats.pending_whatsapp_orders }}</h4>
                        <small class="text-info"><i class="fab fa-whatsapp"></i> Pending</small>
                    </div>
                    <div class="col-auto">
                        <i class="fab fa-whatsapp fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mb-4">
        <!-- Sales Chart -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sales Overview (Last 7 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('pos.index') }}" class="btn btn-primary">
                        <i class="fas fa-cash-register me-2"></i>New Sale
                    </a>
                    
                        {% if current_user.is_admin %}
                    <a href="{{ url_for('products.add_product') }}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add Product
                    </a>
                    
                    <a href="{{ url_for('products.add_purchase') }}" class="btn btn-info">
                        <i class="fas fa-shopping-cart me-2"></i>Record Purchase
                    </a>
                    
                    <a href="{{ url_for('reports.index') }}" class="btn btn-warning">
                        <i class="fas fa-chart-bar me-2"></i>View Reports
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <!-- Recent Sales -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Sales</h5>
                <a href="{{ url_for('pos.sales') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                {% if recent_sales %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Sale #</th>
                                <th>Customer</th>
                                <th>Total</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in recent_sales %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('pos.view_sale', sale_id=sale.id) }}" class="text-decoration-none">
                                        {{ sale.sale_number }}
                                    </a>
                                </td>
                                <td>{{ sale.customer_name or 'Walk-in' }}</td>
                                <td>{{ formatCurrency(sale.total_amount) }}</td>
                                <td>{{ sale.sale_date.strftime('%m/%d %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-receipt fa-2x mb-2"></i>
                    <p>No sales yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <!-- Low Stock Alert -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Low Stock Alert</h5>
                <a href="{{ url_for('products.stock') }}?filter=low" class="btn btn-sm btn-outline-warning">View All</a>
            </div>
            <div class="card-body p-0">
                {% if low_stock_products %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Reorder Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in low_stock_products %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('products.view_product', id=product.id) }}" class="text-decoration-none">
                                        {{ product.name }}
                                    </a>
                                </td>
                                <td>{{ product.stock_quantity }}</td>
                                <td>{{ product.reorder_level }}</td>
                                <td>
                                    {% if product.stock_quantity == 0 %}
                                        <span class="badge bg-danger">Out of Stock</span>
                                    {% else %}
                                        <span class="badge bg-warning">Low Stock</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                    <p>All products have sufficient stock</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if pending_orders %}
<div class="row">
    <div class="col-12">
        <!-- Pending WhatsApp Orders -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Pending WhatsApp Orders</h5>
                <a href="{{ url_for('pos.whatsapp_orders') }}" class="btn btn-sm btn-outline-success">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in pending_orders %}
                            <tr>
                                <td>
                                    {{ order.customer_name or order.customer_phone }}
                                    <br><small class="text-muted">{{ order.customer_phone }}</small>
                                </td>
                                <td>{{ order.product.name }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>{{ order.created_at.strftime('%m/%d %H:%M') }}</td>
                                <td>
                                    <a href="{{ url_for('pos.convert_whatsapp_order', order_id=order.id) }}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-shopping-cart"></i> Convert to Sale
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format currency helper
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-KE', {
            style: 'currency',
            currency: 'KES',
            minimumFractionDigits: 2
        }).format(amount);
    };

    // Sales Chart
    fetch('{{ url_for("main.dashboard_chart_data") }}')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('salesChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.sales_data.map(item => {
                        const date = new Date(item.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Sales Amount',
                        data: data.sales_data.map(item => item.total),
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            document.getElementById('salesChart').innerHTML = '<div class="text-center p-4 text-muted">Error loading chart data</div>';
        });
});
</script>
{% endblock %}