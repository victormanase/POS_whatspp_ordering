{% extends "base.html" %}

{% block title %}Add Product{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Add New Product</h2>
                <a href="{{ url_for('products.products') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Products
                </a>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Product Information</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" enctype="multipart/form-data" id="addProductForm">
                                {{ form.hidden_tag() }}
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.name.label(class="form-label") }}
                                            {{ form.name(class="form-control") }}
                                            {% if form.name.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.name.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.barcode.label(class="form-label") }}
                                            <div class="input-group">
                                                {{ form.barcode(class="form-control") }}
                                                <button type="button" class="btn btn-outline-secondary" onclick="generateBarcode()">
                                                    <i class="fas fa-random"></i>
                                                </button>
                                            </div>
                                            {% if form.barcode.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.barcode.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    {{ form.description.label(class="form-label") }}
                                    {{ form.description(class="form-control", rows="3") }}
                                    {% if form.description.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.description.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.category_id.label(class="form-label") }}
                                            {{ form.category_id(class="form-select") }}
                                            {% if form.category_id.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.category_id.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.image.label(class="form-label") }}
                                            {{ form.image(class="form-control") }}
                                            {% if form.image.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.image.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Upload product image (optional)</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.buying_price.label(class="form-label") }}
                                            <div class="input-group">
                                                <span class="input-group-text">{{ get_current_currency().symbol }}</span>
                                                {{ form.buying_price(class="form-control", step="0.01") }}
                                            </div>
                                            {% if form.buying_price.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.buying_price.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.selling_price.label(class="form-label") }}
                                            <div class="input-group">
                                                <span class="input-group-text">{{ get_current_currency().symbol }}</span>
                                                {{ form.selling_price(class="form-control", step="0.01") }}
                                            </div>
                                            {% if form.selling_price.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.selling_price.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ form.stock_quantity.label(class="form-label") }}
                                            {{ form.stock_quantity(class="form-control") }}
                                            {% if form.stock_quantity.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.stock_quantity.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ form.reorder_level.label(class="form-label") }}
                                            {{ form.reorder_level(class="form-control") }}
                                            {% if form.reorder_level.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.reorder_level.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Minimum stock before reorder alert</div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Tax Setting</label>
                                            <div class="form-check">
                                                {{ form.tax_inclusive(class="form-check-input") }}
                                                {{ form.tax_inclusive.label(class="form-check-label") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{{ url_for('products.products') }}" class="btn btn-secondary me-md-2">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </a>
                                    {{ form.submit(class="btn btn-primary") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Pricing Information</h6>
                        </div>
                        <div class="card-body">
                            <div id="pricingInfo">
                                <p class="text-muted">Enter buying and selling prices to see profit margin.</p>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">Tips</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled small">
                                <li class="mb-2">
                                    <i class="fas fa-lightbulb text-warning me-1"></i>
                                    Use descriptive names for easy searching
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-lightbulb text-warning me-1"></i>
                                    Set appropriate reorder levels to avoid stockouts
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-lightbulb text-warning me-1"></i>
                                    Upload clear product images for better identification
                                </li>
                                <li>
                                    <i class="fas fa-lightbulb text-warning me-1"></i>
                                    Check tax inclusive setting based on your pricing strategy
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function generateBarcode() {
    const barcodeField = document.getElementById('barcode');
    const randomCode = Date.now().toString() + Math.random().toString(36).substr(2, 5);
    barcodeField.value = randomCode.substr(0, 12);
}

function calculateProfitMargin() {
    const buyingPrice = parseFloat(document.getElementById('buying_price').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('selling_price').value) || 0;
    
    const pricingInfo = document.getElementById('pricingInfo');
    
    if (buyingPrice > 0 && sellingPrice > 0) {
        const profit = sellingPrice - buyingPrice;
        const marginPercent = ((profit / buyingPrice) * 100).toFixed(2);
        
        let profitClass = 'text-success';
        if (marginPercent < 10) profitClass = 'text-warning';
        if (marginPercent < 0) profitClass = 'text-danger';
        
        pricingInfo.innerHTML = `
            <div class="row text-center">
                <div class="col-12 mb-2">
                    <small class="text-muted">Profit per Unit</small>
                    <div class="fw-bold ${profitClass}">{{ get_current_currency().symbol }} ${profit.toFixed(2)}</div>
                </div>
                <div class="col-12">
                    <small class="text-muted">Profit Margin</small>
                    <div class="fw-bold ${profitClass}">${marginPercent}%</div>
                </div>
            </div>
        `;
    } else {
        pricingInfo.innerHTML = '<p class="text-muted">Enter buying and selling prices to see profit margin.</p>';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for price calculation
    const buyingPriceField = document.getElementById('buying_price');
    const sellingPriceField = document.getElementById('selling_price');
    
    if (buyingPriceField) buyingPriceField.addEventListener('input', calculateProfitMargin);
    if (sellingPriceField) sellingPriceField.addEventListener('input', calculateProfitMargin);
    
    // Calculate initial values
    calculateProfitMargin();
});
</script>
{% endblock %}